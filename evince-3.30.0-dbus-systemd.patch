From e5cece55c2019d953b175f2a5fd2a56621b97145 Mon Sep 17 00:00:00 2001
From: Bastien Nocera <hadess@hadess.net>
Date: Sat, 22 Sep 2018 12:04:52 +0200
Subject: [PATCH 1/2] build: Print systemd unit installation status

---
 configure.ac | 1 +
 1 file changed, 1 insertion(+)

diff --git a/configure.ac b/configure.ac
index 77e3cda3..c5a23d37 100644
--- a/configure.ac
+++ b/configure.ac
@@ -1042,6 +1042,7 @@ FEATURES
 GTK Doc reference ........:  $enable_gtk_doc
 GObject Introspection ....:  $enable_introspection
 DBUS communication .......:  $enable_dbus
+systemd units installation:  $systemd_userdir
 Keyring integration ......:  $with_keyring
 GTK+ Unix Print ..........:  $with_gtk_unix_print
 Thumbnail cache ..........:  $enable_gnome_desktop
-- 
2.17.1


From 5e5e42f6cad0e65557314a1a15cbb1582201f22b Mon Sep 17 00:00:00 2001
From: Bastien Nocera <hadess@hadess.net>
Date: Sat, 22 Sep 2018 12:05:29 +0200
Subject: [PATCH 2/2] shell: Don't reference systemd service

It doesn't get exported outside the sandbox, so the session systemd
doesn't know how to start it. The information in the systemd .service
file should be enough for systemd to correlate the two when running
outside the sandbox.
---
 data/Makefile.am                        | 10 +---------
 data/org.gnome.Evince.Daemon.service.in |  1 -
 2 files changed, 1 insertion(+), 10 deletions(-)

diff --git a/data/Makefile.am b/data/Makefile.am
index 777ed728..22b84481 100644
--- a/data/Makefile.am
+++ b/data/Makefile.am
@@ -44,20 +44,12 @@ systemd_user_DATA = $(systemd_user_in_files:.service.in=.service)
 
 $(systemd_user_DATA): $(systemd_user_in_files) Makefile
 	$(AM_V_GEN) $(SED) -e "s|\@libexecdir\@|$(libexecdir)|" $< > $@
+endif
 
 $(service_DATA): $(service_in_files) Makefile
 	$(AM_V_GEN) $(SED) \
 		-e "s|\@libexecdir\@|$(libexecdir)|" \
-		-e "s|@if_systemd_service@||" \
 		$< > $@
-else
-$(service_DATA): $(service_in_files) Makefile
-	$(AM_V_GEN) $(SED) \
-		-e "s|\@libexecdir\@|$(libexecdir)|" \
-		-e "s|@if_systemd_service@|#|" \
-		$< > $@
-endif
-
 endif
 
 #
diff --git a/data/org.gnome.Evince.Daemon.service.in b/data/org.gnome.Evince.Daemon.service.in
index 8171b099..c51f3bf0 100644
--- a/data/org.gnome.Evince.Daemon.service.in
+++ b/data/org.gnome.Evince.Daemon.service.in
@@ -1,4 +1,3 @@
 [D-BUS Service]
 Name=org.gnome.Evince.Daemon
 Exec=@libexecdir@/evinced
-@if_systemd_service@SystemdService=org.gnome.Evince.service
-- 
2.17.1

